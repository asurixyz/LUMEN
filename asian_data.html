<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contemporary Asian Data - Economic Indicators</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Georgia, 'Times New Roman', serif;
      background-color: #fdfdfd;
      color: #222;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 1.5rem;
      font-weight: 500;
      margin: 0;
    }
    .home-link {
      color: #004080;
      text-decoration: none;
      font-size: 1rem;
    }
    .home-link:hover {
      text-decoration: underline;
    }
    main {
      max-width: 960px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    .controls {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .controls label {
      font-size: 1.1rem;
      font-weight: bold;
    }
    #chart-selector {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 1rem;
      padding: 0.5rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
    }
    #chart-container {
      width: 100%;
    }
    #chart {
      width: 100%;
      height: 65vh;
      min-height: 400px;
    }
    .chart-desc {
      margin-top: 0.75rem;
      color: #555;
      font-size: 0.95rem;
      font-style: italic;
    }
    .population-charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
    }
    .country-chart-container h2 {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .country-chart {
      width: 100%;
      height: 300px;
    }
    footer {
      text-align: center;
      padding: 2rem;
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #777;
      border-top: 1px solid #eee;
    }
    footer a {
      color: #004080;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      header h1 { font-size: 1.2rem; }
      main { margin: 1.5rem auto; padding: 0 1rem; }
      .controls { flex-direction: column; align-items: flex-start; }
      .population-charts-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Asian Economic Indicators</h1>
    <a href="home.html" class="home-link">← Return to Dashboard Index</a>
  </header>

  <main>
    <div class="controls">
      <label for="chart-selector">Select Dataset:</label>
      <select id="chart-selector">
        <option value="fdi" data-file="Economic Data/FDI Data.csv">Foreign Direct Investment</option>
        <option value="consumption" data-file="Economic Data/Consumption GDP Data.csv">Consumption (% of GDP)</option>
        <option value="savings" data-file="Economic Data/Gross Savings Data.csv">Gross Savings (% of GDP)</option>
        <option value="labour" data-file="Economic Data/Labour Force Data.csv">Total Labour Force</option>
        <option value="migration" data-file="Economic Data/Net Migration Data.csv">Net Migration</option>
        <option value="population" data-file="Economic Data/Population Data.csv">Total Population</option>
        <option value="urban" data-file="Economic Data/Urban Population Data.csv">Urban Population</option>
        <option value="tfr" data-file="Economic Data/TFR Data.csv">Total Fertility Rate</option>
        <option value="population_comp">Population Age Composition</option>
      </select>
    </div>
    <div id="chart-container">
      <div id="chart"></div>
      <div id="chart-desc" class="chart-desc"></div>
    </div>
  </main>

  <footer>
    © Venkatakrishnan Asuri ·
    <a href="https://github.com/asurixyz" target="_blank" rel="noopener">GitHub</a> ·
    <a href="https://www.linkedin.com/in/asurixyz" target="_blank" rel="noopener">LinkedIn</a>
  </footer>

  <script>
    const ASEAN_COUNTRIES = ['Brunei Darussalam', 'Cambodia', 'Indonesia', 'Lao PDR', 'Malaysia', 'Myanmar', 'Philippines', 'Singapore', 'Thailand', 'Viet Nam'];
    const TARGET_COUNTRIES = ['China', 'Japan', 'India', 'Korea, Rep.', 'Taiwan, China'];

    const PLOTLY_LAYOUT = {
        font: { family: 'Georgia, serif' },
        legend: { orientation: 'h', y: -0.2 },
        margin: { t: 50, b: 100 },
        paper_bgcolor: '#fdfdfd',
        plot_bgcolor: '#fdfdfd'
    };

    function numberize(val) {
      if (val == null) return null;
      if (typeof val === 'number') return Number.isFinite(val) ? val : null;
      if (typeof val === 'string') {
        const t = val.replace(/[,$%]/g, '').trim();
        if (t === '') return null;
        const n = Number(t);
        return Number.isFinite(n) ? n : null;
      }
      return null;
    }

    function parseCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          transformHeader: h => h.trim(),
          beforeFirstChunk: function(chunk) {
            const lines = chunk.split('\n');
            let headerIndex = -1;
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].includes('Country Name') || lines[i].includes('REF_AREA')) {
                headerIndex = i;
                break;
              }
            }
            if (headerIndex !== -1) return lines.slice(headerIndex).join('\n');
            return chunk;
          },
          complete: (results) => resolve(results.data),
          error: (err) => reject(err)
        });
      });
    }

    function parseTFR_CSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: function(results) {
            const longRows = results.data.filter(d => d.REF_AREA_LABEL && d.TIME_PERIOD && d.OBS_VALUE != null);
            const wideData = {};
            longRows.forEach(row => {
              const country = row.REF_AREA_LABEL;
              const year = row.TIME_PERIOD;
              const value = row.OBS_VALUE;
              if (!wideData[country]) {
                wideData[country] = { 'Country Name': country };
              }
              wideData[country][year] = value;
            });
            resolve(Object.values(wideData));
          },
          error: (err) => reject(err)
        });
      });
    }

    function wideToLongWB(rawRows, valueColName, filterCountries = null) {
      if (!rawRows || rawRows.length === 0) return [];
      const years = Object.keys(rawRows[0]).filter(k => /^\d{4}$/.test(k));
      const result = [];
      rawRows.forEach(row => {
        const country = row["Country Name"] || row["Country"];
        if (filterCountries && !filterCountries.includes(country) && !ASEAN_COUNTRIES.includes(country)) return;
        years.forEach(year => {
          result.push({ Country: country, Year: +year, Value: numberize(row[year]) });
        });
      });
      return result;
    }

    function aggregateASEAN(longRows, isPercentage) {
      const years = [...new Set(longRows.map(d => d.Year))];
      const out = {};
      for (const year of years) {
        const aseanRows = longRows.filter(d => ASEAN_COUNTRIES.includes(d.Country) && d.Year === year);
        const nums = aseanRows.map(r => r.Value).filter(v => v != null);
        if (nums.length > 0) {
          out[year] = isPercentage ? nums.reduce((a, b) => a + b, 0) / nums.length : nums.reduce((a, b) => a + b, 0);
        } else {
          out[year] = null;
        }
      }
      return out;
    }

    function buildTraces(longRows, scale = 1, isPercentage = false) {
      const years = [...new Set(longRows.map(d => d.Year))].sort((a, b) => a - b);
      const traces = [];
      for (const country of TARGET_COUNTRIES) {
        const cLong = longRows.filter(d => d.Country === country);
        if (cLong.length === 0) continue;
        traces.push({
          x: years,
          y: years.map(y => {
            const v = cLong.find(d => d.Year === y);
            return v && v.Value != null ? v.Value / scale : null;
          }),
          mode: 'lines+markers',
          name: country
        });
      }
      const aseanAgg = aggregateASEAN(longRows, isPercentage);
      traces.push({
        x: years,
        y: years.map(y => aseanAgg[y] != null ? aseanAgg[y] / scale : null),
        mode: 'lines+markers',
        name: 'ASEAN'
      });
      return traces;
    }

    const plotFDI = async (file) => {
      const data = await parseCSV(file);
      const longRows = wideToLongWB(data, "FDI", TARGET_COUNTRIES);
      const traces = buildTraces(longRows, 1e9);
      const layout = { ...PLOTLY_LAYOUT, title: 'Foreign Direct Investment (Net Inflows)', xaxis: { title: 'Year' }, yaxis: { title: 'FDI (Billion USD)' } };
      Plotly.newPlot('chart', traces, layout, { responsive: true });
      document.getElementById('chart-desc').textContent = 'FDI net inflows for major Asian economies and ASEAN aggregate.';
    };

    const plotConsumption = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Consumption", TARGET_COUNTRIES);
        const traces = buildTraces(longRows, 1, true);
        const layout = { ...PLOTLY_LAYOUT, title: 'Final Consumption Expenditure (% of GDP)', xaxis: { title: 'Year' }, yaxis: { title: '% of GDP' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Final consumption expenditure as a percentage of GDP.';
    };

    const plotSavings = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Savings", TARGET_COUNTRIES).filter(d => d.Year >= 1975);
        const traces = buildTraces(longRows, 1, true);
        const layout = { ...PLOTLY_LAYOUT, title: 'Gross Savings (% of GDP)', xaxis: { title: 'Year' }, yaxis: { title: '% of GDP' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Gross savings as a percentage of GDP, from 1975 onwards.';
    };

    const plotLabourForce = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Labour", TARGET_COUNTRIES).filter(d => d.Year >= 1990);
        const traces = buildTraces(longRows, 1e6);
        const layout = { ...PLOTLY_LAYOUT, title: 'Total Labour Force', xaxis: { title: 'Year' }, yaxis: { title: 'Labour Force (Millions)' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Total labour force size, from 1990 onwards.';
    };

    const plotNetMigration = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Migration", TARGET_COUNTRIES);
        const traces = buildTraces(longRows, 1);
        const layout = { ...PLOTLY_LAYOUT, title: 'Net Migration', xaxis: { title: 'Year' }, yaxis: { title: 'Net Migration (Number of People)' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Net migration figures for major Asian economies and ASEAN.';
    };

    const plotUrbanPopulation = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Urban Pop", TARGET_COUNTRIES);
        const traces = buildTraces(longRows, 1e6);
        const layout = { ...PLOTLY_LAYOUT, title: 'Urban Population', xaxis: { title: 'Year' }, yaxis: { title: 'Urban Population (Millions)' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Total urban population over time.';
    };

    const plotPopulation = async (file) => {
        const data = await parseCSV(file);
        const longRows = wideToLongWB(data, "Population", TARGET_COUNTRIES);
        const traces = buildTraces(longRows, 1e6);
        const layout = { ...PLOTLY_LAYOUT, title: 'Total Population', xaxis: { title: 'Year' }, yaxis: { title: 'Population (Millions)' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Total population over time.';
    };
    
    const plotTFR = async (file) => {
        const data = await parseTFR_CSV(file);
        const longRows = wideToLongWB(data, "TFR", TARGET_COUNTRIES);
        const traces = buildTraces(longRows, 1, true);
        const layout = { ...PLOTLY_LAYOUT, title: 'Total Fertility Rate (TFR)', xaxis: { title: 'Year' }, yaxis: { title: 'Births Per Woman' } };
        Plotly.newPlot('chart', traces, layout, { responsive: true });
        document.getElementById('chart-desc').textContent = 'Total fertility rate (births per woman) by country/region.';
    };

    const plotIndividualPopulationCompositions = async () => {
      const container = document.getElementById('chart-container');
      container.innerHTML = `<div id="chart-desc" class="chart-desc">Loading Population Data...</div><div class="population-charts-grid"></div>`;
      try {
        const [data0_14, data15_64, data65] = await Promise.all([
          parseCSV('Economic Data/Population 0-14 Data.csv'),
          parseCSV('Economic Data/Population 15-64 Data.csv'),
          parseCSV('Economic Data/Population 65 Data.csv')
        ]);
        
        const longRows0_14 = wideToLongWB(data0_14, 'Pop 0-14');
        const longRows15_64 = wideToLongWB(data15_64, 'Pop 15-64');
        const longRows65 = wideToLongWB(data65, 'Pop 65+');
        
        document.getElementById('chart-desc').textContent = 'Population composition by age group for each major Asian economy and ASEAN.';
        const gridContainer = document.querySelector('.population-charts-grid');
        
        const plotCountries = ['China', 'Japan', 'India', 'Korea, Rep.', 'Indonesia', 'ASEAN'];
        for (const country of plotCountries) {
          const chartDiv = document.createElement('div');
          chartDiv.className = 'country-chart-container';
          const chartId = `chart-${country.replace(/[^a-zA-Z0-9]/g, '')}`;
          chartDiv.innerHTML = `<h2>${country}</h2><div id="${chartId}" class="country-chart"></div>`;
          gridContainer.appendChild(chartDiv);
          
          let countryRows0_14, countryRows15_64, countryRows65;
          if (country === 'ASEAN') {
            countryRows0_14 = longRows0_14.filter(d => ASEAN_COUNTRIES.includes(d.Country));
            countryRows15_64 = longRows15_64.filter(d => ASEAN_COUNTRIES.includes(d.Country));
            countryRows65 = longRows65.filter(d => ASEAN_COUNTRIES.includes(d.Country));
          } else {
            countryRows0_14 = longRows0_14.filter(d => d.Country === country);
            countryRows15_64 = longRows15_64.filter(d => d.Country === country);
            countryRows65 = longRows65.filter(d => d.Country === country);
          }
          
          const years = [...new Set(countryRows0_14.map(d => d.Year))].sort((a,b)=>a-b);
          
          const getAverages = (rows) => {
            const out = {};
            years.forEach(year => {
              const yearRows = rows.filter(d => d.Year === year);
              const nums = yearRows.map(r => r.Value).filter(v => v != null);
              out[year] = nums.length > 0 ? nums.reduce((a, b) => a + b, 0) / nums.length : null;
            });
            return out;
          };

          const values0_14 = (country === 'ASEAN') ? getAverages(countryRows0_14) : {};
          const values15_64 = (country === 'ASEAN') ? getAverages(countryRows15_64) : {};
          const values65 = (country === 'ASEAN') ? getAverages(countryRows65) : {};
          
          const traces = [
              { x: years, y: years.map(y => (country === 'ASEAN' ? values0_14[y] : (countryRows0_14.find(d=>d.Year===y)?.Value ?? null))), name: '0-14', mode: 'lines', line: {width:0}, fill: 'tonexty', stackgroup: 'one', fillcolor: 'rgba(31, 119, 180, 0.7)' },
              { x: years, y: years.map(y => (country === 'ASEAN' ? values15_64[y] : (countryRows15_64.find(d=>d.Year===y)?.Value ?? null))), name: '15-64', mode: 'lines', line: {width:0}, fill: 'tonexty', stackgroup: 'one', fillcolor: 'rgba(44, 160, 44, 0.7)' },
              { x: years, y: years.map(y => (country === 'ASEAN' ? values65[y] : (countryRows65.find(d=>d.Year===y)?.Value ?? null))), name: '65+', mode: 'lines', line: {width:0}, fill: 'tonexty', stackgroup: 'one', fillcolor: 'rgba(255, 127, 14, 0.7)' }
          ];
          
          const layout = { ...PLOTLY_LAYOUT, yaxis: { title: '% of Total Population', range: [0, 100]}, showlegend: true, legend: {orientation: 'h', y: -0.3} };
          Plotly.newPlot(chartId, traces, layout, {responsive: true});
        }
      } catch (err) {
        document.getElementById('chart-desc').textContent = 'Error loading population data.';
        console.error('Error:', err);
      }
    };

    async function loadChart(selectedOption) {
        const chartType = selectedOption.value;
        const file = selectedOption.dataset.file;
        const container = document.getElementById('chart-container');
        
        // Reset the view to a single chart for most cases
        if (chartType !== 'population_comp') {
            container.innerHTML = `<div id="chart"></div><div id="chart-desc" class="chart-desc"></div>`;
        }
        document.getElementById('chart-desc').textContent = 'Loading...';

        try {
            switch (chartType) {
                case 'fdi': await plotFDI(file); break;
                case 'consumption': await plotConsumption(file); break;
                case 'savings': await plotSavings(file); break;
                case 'labour': await plotLabourForce(file); break;
                case 'migration': await plotNetMigration(file); break;
                case 'population': await plotPopulation(file); break;
                case 'urban': await plotUrbanPopulation(file); break;
                case 'tfr': await plotTFR(file); break;
                case 'population_comp': await plotIndividualPopulationCompositions(); break;
                default: document.getElementById('chart').innerText = 'Unknown chart type';
            }
        } catch (err) {
            document.getElementById('chart-desc').textContent = `Error loading data for ${chartType}.`;
            console.error('Error loading:', file, err);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
      const selector = document.getElementById('chart-selector');
      selector.addEventListener('change', () => {
        loadChart(selector.options[selector.selectedIndex]);
      });
      loadChart(selector.options[selector.selectedIndex]); // Initial load
    });
  </script>
</body>
</html>
